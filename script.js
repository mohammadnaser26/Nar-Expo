const SHEET_URL = "https://exp-xug8.onrender.com/submit";

// Embedded texts data to avoid CORS issues when loading locally
const TEXTS_DATA = [
    {
      "title": "Hindenburg disaster",
      "narrative": "It was a sunny day on the 6th of May, 1937, in the borough of Lakehurst, when Mike decided to take his family out to watch the landing and takeoff of airships, as that is something that Mike loves doing with his son, as it has been something he had always done with his father. Mike had a friend in the ground crew, so he was able to get more information for his son and teach him about the airships as they flew over them, such as the manifest of the flight, which managed to hold 97 individuals, and what kind of gas they used in blowing up the air balloon. When he told his son that they use hydrogen to fill up the airship, his son was shocked and asked if it is the same hydrogen as the one that is present in the water he drinks. Soon after, Mike and his family witnessed a ball of fire in the air, which lasted about 40 minutes. Mike rushed in to help, and he later overheard that 36 people had unfortunately lost their lives due to the event that they had just witnessed. When Mike's son asked him what does this mean for the airship era, Mike said that this fire may have just ended it. The only lesson Mike was able to depart upon his son was to avoid hydrogen, but to use helium if need be, as it isn't as flammable.",
      "questions": [
        "What year did the disaster happen?",
        "What type of vehicle is it?",
        "How many people died?",
        "What element was the airship filled with?",
        "How many people were on board?",
        "How long did it take to engulf the vessel in flame?",
        "Name of airship that caught fire?",
        "What caused the end of the airship era?",
        "What gas replaced hydrogen because of this event?",
        "Where did the disaster happen?"
      ],
      "expository": "Airships were once considered the future of luxury travel, as they allowed people to fly in style and comfort. The most infamous airship was the Hindenburg. It was the largest airship built during that time period. It was making a trip from Frankfurt, Germany, to the United States. According to the passenger manifest, there were 97 people aboard, passengers and crew included. On the day of May 6, 1937, there was a fire that engulfed the sky in Lakehurst borough. According to witnesses, the fire lasted about 40 seconds. Upon arriving at the scene, first responders tried to save as many people as they could. According to the official death toll, 36 people had died. One of them was a ground worker. This event led to many changes, such as people losing trust in airships, which led to the end of the airship era, and more effort and investment being directed towards airplanes. Another change was the shift from hydrogen to helium, which is a less flammable material. This event is still remembered as one of the most unfortunate and tragic events."
    },
    {
      "title": "The Invention of the Birth Control Pill",
      "narrative": "It was the early 1950s, and Carl Djerassi was hard at work in his modest lab in Mexico City, surrounded by chemicals, glassware, and a sense of urgency. He had just been handed a challenge by his employers at Syntex, a small pharmaceutical company: create a synthetic compound that could act as an oral contraceptive. The idea had been floating around for some time, but no one had found the key to making it practical. His first hurdle was finding a way to synthesize progesterone, a hormone that could mimic the effects of the natural hormone in the body. Progesterone, when taken orally, was broken down by the digestive system and didn't work as intended. He needed a stable, effective version of it that could be absorbed by the body. Days bled into weeks as Djerassi and his team scoured the scientific literature and conducted experiments. They looked at various plants, trying to find compounds that could be converted into the progesterone-like hormone they needed. Then, one day, a breakthrough came when they turned their attention to the Mexican yam (Dioscorea mexicana). The yam's root contained a substance called diosgenin, a steroid that could be transformed into progesterone. Djerassi's heart raced as he realized the potential of this discovery. The yams were cheap, abundant, and could be processed into the necessary compounds with far less cost than extracting progesterone from animal sources. It was a game-changer. Months of sleepless nights followed, filled with intense calculations, reactions, and meticulous tests. Finally, the day came when Djerassi and his team successfully synthesized norethindrone, a compound that worked as a synthetic version of progesterone. This new hormone not only prevented the release of an egg from the ovary, but also thickened the cervical mucus to make it harder for sperm to travel and altered the uterine lining in order to prevent implantation of a fertilized egg—an elegant, multi-layered defense against pregnancy. It mimicked the effects of natural progesterone and—most importantly—could be taken orally. The team knew they had made a pivotal discovery. As he looked over the small vial containing the synthetic hormone, Djerassi allowed himself a moment of quiet pride. He had helped create something that would not only change science but change society itself.",
      "questions": [
        "What's the country of origin of the plant used by Djerassi?",
        "What's the connection between norethindrone and progesterone?",
        "What's diosgenin?",
        "Why couldn't natural progesterone be used as the basis for the birth control pill?",
        "What happens to ovulation when under the influence of norethindrone?",
        "What happens to the cervical mucus when under the influence of norethindrone?",
        "what is the the name of the plant used to derive diosgenin?",
        "what hormone does norethindrone mimic?",
        "Where was the lab located?",
        "What bodily fluid does norethindrone thicken?"
      ],
      "expository": "Norethindrone is a synthesized and orally active form of progesterone used as the basis for the first birth control pill invented in the early 1950s. It was first found in a compound derived from the Mexican wild yam (Dioscorea mexicana). This yam contained diosgenin, a plant steroid that could be chemically transformed into hormones nearly identical to those produced in the human body. Norethindrone became the key ingredient in the first birth control pills because it mimicked progesterone, a hormone that naturally regulates the menstrual cycle. When taken orally, this synthetic hormone suppresses ovulation, meaning no egg is released from the ovaries. It also thickens cervical mucus, making it harder for sperm to travel, and alters the uterine lining, reducing the chances of a fertilized egg implanting. Unlike natural progesterone, which breaks down quickly in the digestive system, norethindrone was chemically stable and effective when swallowed—a critical advancement. Its discovery was more than a scientific milestone. It marked a transformative moment in public health and women's reproductive anatomy. With the ability to be manufactured from an abundant plant source and synthesized efficiently in a laboratory, norethindrone provided a cost-effective and accessible foundation for oral contraceptives. Its development gave women a new degree of control over their fertility and contributed to broader social changes, including increased participation in the workforce and higher educational attainment. What began as a chemical innovation in a lab soon evolved into one of the most influential medical advancements in the 20th century."
    },
    {
      "title": "Three Christs of Ypsilanti",
      "narrative": "I had just finished my degree in Ypsilanti. I wanted to intern for a while to gather some first-hand experience. In 1959, I was offered a position that was close to where I had previously been studying by Milton Rokeach, to be a part of his new study. The pamphlet I was given had very minimal information about what exactly we were doing. My first day in there, I learned that Rokeach was trying to cure three schizophrenic patients who had grandiose delusions. Upon further investigation, I discovered they each believed that they were the messiahs. When the studies first began, I observed how Rokeach would place the three patients within the vicinity of each other, but he would not force them to interact or give them any prompts. Our focus was strictly observing them individually. Eventually, they would be left alone in a room with just the three of them so we could observe whether their interactions with each other would force them to change their worldviews. Initially, all three rejected the claim that the others were the messiah. One of the patients even expressed how the other two were just schizophrenics who were experiencing delusional thoughts. As the study progressed, Rokeach wanted to push them to interact more. He even went as far as taking away their food privileges when they ignored each other. I raised these issues with Rokeach, and he unfortunately didn't see things from my point of view. He insisted that their interactions could help them get cured. When I voiced my concerns a second time, I was told I was no longer welcome to participate in the study. A few months later, as I was reading the papers, I saw the headline discussing Rokeach's failed experiment and how he was being ostracized by the scientific community for ignoring the well-being of the patients in his care.",
      "questions": [
        "Where did the study take place?",
        "Who conducted the study?",
        "How many patients were involved?",
        "What delusion did all participants share?",
        "When did the study take place?",
        "Did the experiment adhere to ethical standards?",
        "Were any of the patients cured?",
        "Why were the patients brought together?",
        "What method was used to study the patients?",
        "What diagnosis did the patients share?"
      ],
      "expository": "In 1959, Milton Rokeach managed to bring together three patients in Ypsilanti Hospital. This study would go on to raise ethical questions in psychology for decades. The study aimed to bring together three patients who all shared the belief that they were the Messiah. The three patients had been diagnosed with paranoid schizophrenia, which is characterized by delusions, hallucinations, and impaired reality testing. The goal was to observe what would happen when individuals with identical delusions were forced to confront each other's realities. Rokeach hoped that placing the three patients in close proximity to each other would lead them to question their beliefs, and this would lead to them being cured of their delusions. The method used was primarily observation—observing the interactions and seeing how each patient dealt with having two other messiahs around them. Despite the best attempts, none of the patients were cured. While their behaviors shifted over time, none of their core ideologies shifted. Each patient maintained their divinity. The study did not lead to personal breakthroughs, but it did give insights into the significance of adhering to ethical standards. It also provided knowledge on identity and belief systems in individuals with schizophrenia."
    },
    {
      "title": "Discovery of blood types (Karl Landsteiner)",
      "narrative": "It was a quiet morning in 1901, when Karl Landsteiner arrived at his laboratory in Vienna, unaware he was about to solve a mystery that has bothered physicians for decades. An immunologist and a physician, Landsteiner had been puzzled by the deaths of patients after blood transfusions, some survived others died. Driven by curiosity he began mixing blood samples from different people. Some combinations clumped together while other remained smooth, through repetition he noticed that this wasn't random and then a pattern started emerging. Eventually, he discovered three distinct blood groups A, B, and O. A fourth group AB was added later, this system was called ABO system, and it explained why mismatched transfusions could trigger immune reactions, the body saw the blood as a threat and attacked it. As news of his work spread, his work was recognized with a Nobel in medicine. Till this day his system is still utilized to ensure all blood transfusions are done with as little risk as possible.",
      "questions": [
        "Who discovered blood types?",
        "What was discovered?",
        "When was the discovery made?",
        "Where did the discovery take place?",
        "Which system was identified?",
        "Why was the discovery important?",
        "What happens when blood types are mismatched?",
        "What award did landsteiner receive?",
        "What field was landsteiner in?",
        "Is the ABO system still in use today?"
      ],
      "expository": "In 1901, Austrian immunologist Karl Landsteiner made a discovery that changed medicine forevermore: the identification of human blood types. Working in Vienna, Landsteiner observed that when he mixed blood samples from different individuals, some combinations clumped while others did not. This reaction, known as agglutination, hinted at fundamental differences in human blood. Through systematic testing he was able to identify three blood groups A, B, and O; a fourth group, known as AB, was added later on. His classification became known as the ABO blood group system, which is still used in medicine today. His results are significant because they showed why some transfusions were successful while others resulted in death. His contribution was so significant that he was awarded a Nobel prize in medicine. Even after a century, his work is still so significant that it is still used to this day. Blood transfusions, which used to be a dangerous last resort only to be used in the most dire situations, are now a reliable and life-saving procedure because of the findings of Landsteiner's work."
    },
    {
      "title": "Discovery behind penicillin",
      "narrative": "In 1928, at St. Mary's Hospital in London, Alexander Fleming made a discovery that would change medicine forever. After returning from his vacation, he noticed that a Petri dish containing bacteria had accidentally been contaminated by a mold, and strangely the bacteria surrounding the mold had been destroyed. He realized that the mold was producing a substance that could kill harmful bacteria; he named it penicillin and tested it against bacterial infections like staphylococcus. However, producing penicillin in large amounts proved difficult. Howard Florey and Ernst Boris helped mass produce it, making it widely available, especially during WW2 where it saved countless lives by treating infected wounds; they used a method called lyophilization to purify the substance effectively. Classified as an antibiotic, penicillin became a revolutionary drug that marked the beginning of a new era in medicine. Its discovery benefited the field of medicine the most, particularly pharmacology, by providing a powerful tool to combat bacterial infections. The discovery was an accident, rooted in an unexpected contamination, and highlighted the importance of careful observation in routine experiments. From a small laboratory in London, penicillin grew into one of the most significant medical breakthroughs.",
      "questions": [
        "Who discovered penicillin?",
        "What type of organism produces penicillin?",
        "In which year was penicillin discovered?",
        "What substance was penicillin first tested against?",
        "Who helped mass-produce penicillin?",
        "What method was used to purify penicillin?",
        "What kind of drug is penicillin classified as?",
        "What accidental event led to penicillin's discovery?",
        "What field of science benefited most from penicillin?",
        "During which war did penicillin save many lives?",
        "What hospital was penicillin discovered in?",
        "Where was penicillin discovered?"
      ],
      "expository": "Penicillin was discovered in 1928 by Alexander Fleming at St. Mary's Hospital in London, and it became one of the greatest breakthroughs in medical history. After returning from his vacation, Fleming observed that a Petri dish containing bacteria had accidentally been contaminated by mold. He noticed that the bacteria surrounding the mold had been destroyed; this led him to realize that mold was capable of producing substances that could kill harmful bacteria. He named the substance penicillin. He first tested it against bacterial infections like staphylococcus and found it to be highly effective. Initially he struggled with producing penicillin in large quantities. Later on, scientists like Howard Florey and Ernst Boris Chain helped mass-produce it, making the drug widely available, especially during World War 2, where it saved countless lives by treating infected wounds and bacterial diseases. To purify penicillin effectively, they used a method called lyophilization, also known as freeze-drying. Penicillin is classified as an antibiotic, a type of drug that prevents the growth of bacteria. Its discovery marked the beginning of a new era in medicine, providing doctors with a powerful tool to combat infections. The accidental nature of the discovery highlights the significance of careful observation during laboratory work. The discovery of penicillin most significantly benefited the field of medicine, and is one of the most important advancements in medical history."
    },
    {
      "title": "The Invention of the Printing Press",
      "narrative": "In the mid-15th century, in a small workshop in Mainz, Germany, a man named Johannes Gutenberg was working on an invention that would transform the world. Inspired by wine presses and movable type used in Asia, Gutenberg combined metal movable type with a screw press to create the first mechanical printing press. Before this, copying a book meant months of laborious work, usually done by monks. Gutenberg's invention changed that. His first major project was printing the Bible—around 180 copies of it, now known as the Gutenberg Bible. For the first time in history, books could be reproduced quickly and in larger quantities, using paper instead of parchment. This made books cheaper and more accessible to people beyond the elite. As the press spread across Europe, so did knowledge. One of the biggest impacts was on the Protestant Reformation, as Martin Luther's ideas could now be printed and shared widely in Latin and local languages. The printing press also changed professions. Scribes were no longer needed, but printers and publishers became essential. A new industry began, and literacy rates began to rise as more people had access to reading material. What began in a German workshop would go on to spark revolutions, challenge authorities, and lay the foundation for the modern information age.",
      "questions": [
        "Who invented the printing press?",
        "in which country was the first printing press invented",
        "what was the first major book printed using the press?",
        "in which century was the printing press invented?",
        "what material replaced parchment due to mass printing?",
        "which movement did the printing press help spread?",
        "what was the main language of early printed books?",
        "what profession was revolutionized by the press?",
        "which industry began to grow rapidly due to printing?",
        "what skill became more common as books became more accessible?"
      ],
      "expository": "The printing press was invented by Johannes Gutenberg in the 15th century, in Mainz, Germany. It combined existing technologies like the wine press with movable metal type to allow for the mass production of books. Before this invention, books were copied by hand—a slow and expensive process typically done by scribes or monks. Gutenberg's invention changed this by making it possible to produce multiple identical copies quickly and more affordably. His first major printed work was the Gutenberg Bible, around 180 copies of which were produced. This marked the beginning of a new era in communication. The primary material used for printing was paper, which replaced expensive parchment. The spread of printed books increased access to knowledge and contributed to rising literacy rates across Europe. The printing press played a major role in spreading the ideas of the Protestant Reformation, as Martin Luther's writings were rapidly reproduced and distributed. Most early printed texts were in Latin, the scholarly language of the time, but vernacular languages soon followed. The invention also transformed the publishing industry and professions tied to bookmaking. Scribes became less essential, while printers and publishers rose to significance, contributing to the development of a thriving book trade. The printing press is often considered one of the most influential inventions in human history."
    },
    {
      "title": "The Gold Standard",
      "narrative": "In the 1800s, many countries tied their money to gold. This system, called the gold standard, meant paper currency could be exchanged for a fixed amount of gold. Britain first adopted it and others followed, creating a sense of global stability. It made international trade easier because currency values were linked to something real. But during World War 1, countries printed money to fund the war—more than their gold supplies could support. This led to inflation and broke the system. Some nations tried to return to the gold standard after the war, but it no longer worked the same. When the Great Depression hit, the system made recovery harder because governments couldn't increase the money supply freely. In 1933, U.S. President Franklin D. Roosevelt took the country off the gold standard for domestic use. Later in 1971, President Richard Nixon ended gold convertibility entirely, cutting the dollar's link to gold even on the international level. After that, money became fiat currency—valuable because governments declared it so. What began as a symbol of trust and strength in currency eventually became too limiting for a modern, flexible economy.",
      "questions": [
        "What metal backed currency under the gold standard?",
        "Which country first adopted the gold standard?",
        "What global conflict caused countries to print excess money?",
        "What major economic crisis followed in the 1930's?",
        "Which U.S. president suspended the gold standard in 1933?",
        "Which U.S. president ended the international gold convertibility in 1971?",
        "What type of money replaced gold backed currency?",
        "What material was paper money once exchangeable for?",
        "What system fixed currencies to each other via gold?",
        "What value supports fiat currency today?"
      ],
      "expository": "The gold standard was a system where money was backed by a fixed amount of gold. Countries like Britain first adopted it in the 1800s, and others followed. Under this system, people could exchange their currency for gold, making international trade more predictable. However, it also limited governments' ability to manage their economies. During World War 1, countries printed money beyond their gold reserves to pay for war costs, causing inflation. After the war, they tried to return to the gold standard, but it was unstable. When the Great Depression struck, many economies struggled because the gold standard limited how much money governments could circulate. In 1933, President Franklin D. Roosevelt suspended the gold standard for domestic use, and citizens could no longer exchange dollars for gold. The final step came in 1971, when President Nixon ended the gold standard on an international level, making the dollar a fiat currency—money that is not backed by gold but by trust in the government. Today, most of the world uses fiat money. While the gold standard once brought economic order, it eventually became too rigid for modern financial systems."
    },
    {
      "title": "The Zimmerman Telegram",
      "narrative": "In early 1917, the United States was still officially neutral in World War 1, supplying food, weapons, and financial aid to the Allied Powers but avoiding direct combat. Most Americans wanted to stay out of the war entirely. Then came the news that changed everything. A secret telegram from Germany to Mexico was intercepted by British intelligence. Sent by German Foreign Minister Arthur Zimmerman, the telegram proposed that Mexico should join the Central Powers and attack the U.S. if America declared war on Germany. In return, Germany promised to help Mexico recover the lost territories of Texas, New Mexico, and Arizona. When the British handed the decoded message to U.S. officials, many in the government doubted its authenticity, suspecting it was a British ploy to manipulate American opinion. But skepticism vanished when Zimmerman himself confirmed the message's authenticity in a public speech. The revelation sent shockwaves through the nation. Americans, already uneasy about Germany's submarine attacks on civilian ships, now felt directly threatened. Public outrage soared. What had once been a European conflict now felt dangerously close to home. In April 1917, President Woodrow Wilson asked Congress to declare war on Germany. The Zimmerman Telegram became the spark that ignited America's entry into World War 1, transforming the nation from a supplier on the sidelines to a full military power on the battlefield.",
      "questions": [
        "Who sent the telegram?",
        "Which country intercepted the message?",
        "What country was the telegram sent to?",
        "What year was the telegram sent?",
        "What was was happening at the time?",
        "Which U.S. state was promised back to Mexico?",
        "What kind of warfare had Germany resumed?",
        "What country did the U.S. support with food and weapons?",
        "Who was the U.S. president during the event?",
        "What was America's stance before joining the war?"
      ],
      "expository": "The Zimmerman Telegram was a secret message sent in January 1917 by German Foreign Minister Arthur Zimmerman to Germany's ambassador in Mexico, proposing a military alliance between Germany and Mexico if the United States entered World War 1. In exchange, Germany promised to support Mexico in reclaiming its former territories of Texas, New Mexico, and Arizona. At the time, the United States had remained neutral in the war, officially avoiding direct military involvement while still providing food, weapons, and financial support to Allied nations like Britain and France. When British intelligence intercepted and decoded the telegram, they passed it to American officials, who were at first skeptical. Some believed the message might be a British trick to push the United States into joining the war. American leaders were cautious; public opinion was still largely against involvement in the European conflict. But the situation changed drastically when Zimmerman publicly admitted that the telegram was real. The idea of Germany encouraging Mexico to attack the United States outraged many Americans, especially as Germany had recently resumed unrestricted submarine warfare. In April 1917, just months after the telegram's release, President Woodrow Wilson asked Congress to declare war on Germany. The Zimmerman Telegram is considered one of the key turning points that led the U.S. to enter World War 1. What was meant to be a covert diplomatic move ended up as a public relations disaster for Germany and pushed a previously neutral nation into the heart of the conflict."
    }
];

let state = {
    currentStep: 0,
    totalSteps: 0,
    participantId: '',
    demographics: {},
    assignedTexts: [],
    currentTextIndex: 0,
    responses: {},
    startTime: Date.now(),
    experimentStartTime: null,
    experimentEndTime: null,
    timerInterval: null,
    timeLeft: 0
};

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2).toUpperCase();
}

function updateProgress() {
    const progress = ((state.currentStep / state.totalSteps) * 100);
    document.getElementById('progress-bar').style.width = progress + '%';
}

function showContainer(html) {
    document.getElementById('container').innerHTML = html;
    updateProgress();
}

// Complete randomization implementation for text selection
function createRandomizedTextSelection(texts) {
  console.log('Creating randomized text selection for participant:', state.participantId);
  
  // Create a seeded random number generator based on participant ID
  const participantHash = state.participantId.substring(Math.max(0, state.participantId.length - 8));
  let participantSeed = 0;
  for (let i = 0; i < participantHash.length; i++) {
    participantSeed = ((participantSeed << 5) - participantSeed + participantHash.charCodeAt(i)) & 0xffffffff;
  }
  participantSeed = Math.abs(participantSeed);
  
  // Seeded random function
  let seed = participantSeed;
  function seededRandom() {
    seed = (seed * 9301 + 49297) % 233280;
    return seed / 233280;
  }
  
  // Fisher-Yates shuffle with seeded random
  function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(seededRandom() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }
  
  // Shuffle the texts to randomize topic selection
  const shuffledTexts = shuffleArray(texts);
  
  const selectedTexts = [];
  const usedTopics = new Set();
  
  // First, try to select 4 different topics for narratives
  for (const text of shuffledTexts) {
    if (selectedTexts.filter(t => t.type === 'narrative').length < 4 && !usedTopics.has(text.title)) {
      selectedTexts.push({
        ...text,
        type: 'narrative',
        content: text.narrative,
        expository: undefined
      });
      usedTopics.add(text.title);
    }
  }
  
  // Then, select 4 different topics for expository (from remaining topics)
  for (const text of shuffledTexts) {
    if (selectedTexts.filter(t => t.type === 'expository').length < 4 && !usedTopics.has(text.title)) {
      selectedTexts.push({
        ...text,
        type: 'expository',
        content: text.expository,
        narrative: undefined
      });
      usedTopics.add(text.title);
    }
  }
  
  // Final shuffle of the selected texts to randomize presentation order
  const finalTexts = shuffleArray(selectedTexts);
  
  console.log('Selected texts for this participant:', finalTexts.map(t => `${t.title} (${t.type})`));
  console.log('Used topics:', Array.from(usedTopics));
  
  return finalTexts;
}


function showConsent() {
    showContainer(`
        <h2>Consent Form</h2>
        <p>This experiment is conducted by <strong>Richárd Reichardt and Mohammad Naser Al-Moqdad</strong> as part of a research project. Your participation is voluntary and anonymous.</p>
        <p>You will be asked to read several texts and answer questions about them. <strong>You will have exactly 5 minutes to read each text.</strong> After the 5-minute timer expires, you will automatically proceed to answer questions about that text. The entire experiment will take approximately 30-40 minutes.</p>
        <form id="consent-form">
            <label>
                <input type="checkbox" id="consent-checkbox" required>
                I have read and understood the above information and consent to participate in this study.
            </label>
            <button type="submit">Begin Experiment</button>
        </form>
    `);
    
    document.getElementById('consent-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (document.getElementById('consent-checkbox').checked) {
            // Start the experiment timer
            state.experimentStartTime = Date.now();
            state.currentStep++;
            showDemographics();
        }
    });
}

function showDemographics() {
    showContainer(`
        <h2>Participant Information</h2>
        <form id="demographics-form">
            <label>
                Age:
                <input type="number" id="age" min="18" max="99" required>
            </label>
            
            <label>
                English Fluency (1=not fluent, 5=native):
                <select id="fluency" required>
                    <option value="">Select fluency level</option>
                    <option value="1">1 - Not fluent</option>
                    <option value="2">2 - Somewhat fluent</option>
                    <option value="3">3 - Average fluency</option>
                    <option value="4">4 - Very fluent</option>
                    <option value="5">5 - Native speaker</option>
                </select>
            </label>
            
            <label>
                Gender:
                <select id="gender" required>
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </label>
            
            <label>
                Education Level:
                <select id="education" required>
                    <option value="">Select education level</option>
                    <option value="Secondary Education">Secondary Education</option>
                    <option value="Bachelor's">Bachelor's</option>
                    <option value="Master's">Master's</option>
                    <option value="Doctorate's">Doctorate's</option>
                </select>
            </label>
            
            <button type="submit">Continue</button>
        </form>
    `);
    
    document.getElementById('demographics-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        state.demographics = {
            age: document.getElementById('age').value,
            fluency: document.getElementById('fluency').value,
            gender: document.getElementById('gender').value,
            education: document.getElementById('education').value
        };
        
        state.currentStep++;
        showText();
    });
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function showText() {
  const currentText = state.assignedTexts[state.currentTextIndex];
  const textContent = currentText.content || currentText.narrative || currentText.expository;
  const textType = currentText.type || (currentText.narrative ? 'narrative' : 'expository');
  
  // Initialize timer
  state.timeLeft = 300; // 5 minutes in seconds
  
  showContainer(`
      <h2>Text ${state.currentTextIndex + 1} of ${state.assignedTexts.length}</h2>
      
      <div class="timer-container">
          <div class="timer-display">
              <strong>Time Remaining: <span id="timer-text">${formatTime(state.timeLeft)}</span></strong>
          </div>
          <div class="timer-bar-bg">
              <div id="timer-bar" class="timer-bar-fg"></div>
          </div>
      </div>
      
      <div class="text-container">
          <h3>${currentText.title}</h3>
          
          <div class="text-content">${textContent}</div>
      </div>
      
      <form id="text-form">
          <button type="submit" id="continue-btn">Continue to Questions</button>
      </form>
  `);
  
  startTimer();
  
  document.getElementById('text-form').addEventListener('submit', function(e) {
      e.preventDefault();
      clearInterval(state.timerInterval);
      state.currentStep++;
      showQuestions();
  });
}


function startTimer() {
    const timerText = document.getElementById('timer-text');
    const timerBar = document.getElementById('timer-bar');
    const continueBtn = document.getElementById('continue-btn');
    
    state.timerInterval = setInterval(function() {
        state.timeLeft--;
        
        // Update timer display
        timerText.textContent = formatTime(state.timeLeft);
        
        // Update timer bar
        const percentage = (state.timeLeft / 300) * 100;
        timerBar.style.width = percentage + '%';
        
        // Change colors as time runs out
        if (state.timeLeft <= 60) {
            timerBar.style.backgroundColor = '#ef4444'; // Red
            timerText.style.color = '#ef4444';
        } else if (state.timeLeft <= 120) {
            timerBar.style.backgroundColor = '#f59e0b'; // Orange
            timerText.style.color = '#f59e0b';
        }
        
        // Auto-advance when timer reaches zero
        if (state.timeLeft <= 0) {
            clearInterval(state.timerInterval);
            timerText.textContent = "Time's up!";
            continueBtn.textContent = "Proceed to Questions";
            continueBtn.style.backgroundColor = '#ef4444';
            
            // Auto-submit after 2 seconds
            setTimeout(function() {
                document.getElementById('text-form').dispatchEvent(new Event('submit'));
            }, 2000);
        }
    }, 1000);
}

function showQuestions() {
    const currentText = state.assignedTexts[state.currentTextIndex];
    const numQuestions = currentText.questions.length; // Dynamic question count
    
    let questionsHtml = '<h2>Questions</h2><form id="questions-form">';
    
    // Add all the comprehension questions (dynamic number)
    currentText.questions.forEach((question, index) => {
        questionsHtml += `
            <div class="question-item">
                <label>
                    ${index + 1}. ${question}
                    <textarea id="q${index}" rows="3" required></textarea>
                </label>
            </div>
        `;
    });
    
    // Add the recall question
    questionsHtml += `
        <div class="question-item">
            <label>
                ${numQuestions + 1}. What do you recall from the topic?
                <textarea id="recall-question" rows="4" required placeholder="Please write what you can remember about this topic..."></textarea>
            </label>
        </div>
    `;
    
    // Add the detailed recall question (replacing familiarity question)
    questionsHtml += `
        <div class="question-item">
            <label>
                ${numQuestions + 2}. Please write down everything you can remember from the passage. Include all main ideas, small details, names, numbers, places, steps, and examples. Use your own words. If you're unsure about something, add it anyway and mark it with a '?'. Keep going until you cannot recall anything else.
                <textarea id="detailed-recall-question" rows="6" required placeholder="Write everything you can remember from the passage..."></textarea>
            </label>
        </div>
    `;
    
    questionsHtml += '<button type="submit">Submit Answers</button></form>';
    
    showContainer(questionsHtml);
    
    document.getElementById('questions-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const answers = [];
        
        // Add recall as first element
        answers.push(document.getElementById('recall-question').value);
        
        // Add detailed recall as second element (replacing familiarity)
        answers.push(document.getElementById('detailed-recall-question').value);
        
        // Add all comprehension question answers (starting from index 2)
        currentText.questions.forEach((question, index) => {
            answers.push(document.getElementById(`q${index}`).value);
        });
        
        const textType = currentText.type === 'narrative' ? 'N' : 'E';
        const textNumber = getTextNumber(currentText, textType);
        const columnName = textType + textNumber;
        
        state.responses[columnName] = answers;
        
        state.currentTextIndex++;
        state.currentStep++;
        
        if (state.currentTextIndex < state.assignedTexts.length) {
            showText();
        } else {
            showCompletion();
        }
    });
}

function getTextNumber(currentText, textType) {
    const textMapping = {
        'Hindenburg disaster': 1,
        'The Invention of the Birth Control Pill': 2,
        'Three Christs of Ypsilanti': 3,
        'Discovery of blood types (Karl Landsteiner)': 4,
        'Discovery behind penicillin': 5,
        'The Invention of the Printing Press': 6,
        'The Gold Standard': 7,
        'The Zimmerman Telegram': 8
    };
    
    return textMapping[currentText.title] || 1;
}

function showCompletion() {
    const currentDuration = Math.round((Date.now() - state.experimentStartTime) / 1000);
    const durationMinutes = Math.floor(currentDuration / 60);
    const durationSeconds = currentDuration % 60;
    
    showContainer(`
        <div class="completion-message">
            <h2>You have completed the experiment.</h2>
            
            <div class="participant-code">
                <p><strong>Your participant code is: <span id="participant-code">${state.participantId}</span></strong></p>
                <p><strong>Experiment duration: ${durationMinutes} minutes and ${durationSeconds} seconds</strong></p>
            </div>
            
            <p>If you have any questions, contact Richard Reichardt at <a href="mailto:reichardt.richard@ppk.elte.hu">reichardt.richard@ppk.elte.hu</a> or Mohammed Naser Al-Moqdad at <a href="mailto:reichardt.richard@ppk.elte.hu">naser@student.elte.hu</a>.</p>
            
            <div id="submission-status">
                <p id="submission-message">Submitting your data...</p>
                <div id="submission-spinner" class="spinner"></div>
            </div>
        </div>
    `);
    
    submitData();
}

async function submitData() {
  // End the experiment timer
  state.experimentEndTime = Date.now();
  const experimentDurationSeconds = Math.round((state.experimentEndTime - state.experimentStartTime) / 1000);
  
  // Create data object matching EXACT sheet column headers for 8 texts
  const submissionData = {
      timestamp: new Date().toISOString(),
      participantid: state.participantId,
      age: state.demographics.age,
      fluency: state.demographics.fluency,
      gender: state.demographics.gender,
      educationlevel: state.demographics.education,
      experimentduration: experimentDurationSeconds,
      N1: state.responses.N1 || '',
      E1: state.responses.E1 || '',
      N2: state.responses.N2 || '',
      E2: state.responses.E2 || '',
      N3: state.responses.N3 || '',
      E3: state.responses.E3 || '',
      N4: state.responses.N4 || '',
      E4: state.responses.E4 || '',
      N5: state.responses.N5 || '',
      E5: state.responses.E5 || '',
      N6: state.responses.N6 || '',
      E6: state.responses.E6 || '',
      N7: state.responses.N7 || '',
      E7: state.responses.E7 || '',
      N8: state.responses.N8 || '',
      E8: state.responses.E8 || ''
  };

  // Log the data being sent for debugging
  console.log('Submitting data:', submissionData);
  console.log('Assigned texts for this participant:', state.assignedTexts.map(t => t.title));
  console.log('Experiment duration:', experimentDurationSeconds, 'seconds (', Math.round(experimentDurationSeconds / 60), 'minutes )');
  
  try {
      const response = await fetch(SHEET_URL, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(submissionData)
      });

      const result = await response.json();
      
      if (response.ok && result.success) {
          document.getElementById('submission-message').innerHTML = '<strong style="color: green;">Data submitted successfully!</strong>';
          document.getElementById('submission-spinner').style.display = 'none';
      } else {
          throw new Error(result.error || 'Submission failed');
      }
      
  } catch (error) {
      console.error('Error submitting data:', error);
      document.getElementById('submission-message').innerHTML = `
          <strong style="color: red;">Failed to submit data.</strong><br>
          <small>Error: ${error.message}</small><br>
          <small>Please save your participant code: <strong>${state.participantId}</strong></small>
      `;
      document.getElementById('submission-spinner').style.display = 'none';
  }
}


async function initExperiment() {
    try {
        // Use embedded data instead of fetching from JSON file
        const texts = TEXTS_DATA;
        
        state.participantId = generateId();
        state.assignedTexts = createRandomizedTextSelection(texts);
        state.totalSteps = 2 + (state.assignedTexts.length * 2);
        
        console.log('Assigned texts for participant', state.participantId, ':', state.assignedTexts.map(t => t.title));
        
        showConsent();
        
    } catch (error) {
        console.error('Error initializing experiment:', error);
        showContainer(`
            <h2>Error</h2>
            <p>Sorry, there was an error loading the experiment. Please refresh the page and try again.</p>
        `);
    }
}

document.addEventListener('DOMContentLoaded', initExperiment);
